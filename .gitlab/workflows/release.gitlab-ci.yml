# GitLab CI Release Workflow
# Handles semantic versioning and release creation for Python Documentation Init

# Template for release-related jobs
.release_base:
  image: ghcr.io/astral-sh/uv:0.9.2-python3.11-bookworm-slim
  stage: release
  variables:
    GIT_DEPTH: 0 # Full history needed for semantic-release
    GIT_STRATEGY: fetch
    GIT_SUBMODULE_STRATEGY: none
    GITLAB_HOST: $CI_SERVER_HOST
    UV_LINK_MODE: "copy"
    UV_CACHE_DIR: ".uv-cache"
    UV_SYSTEM_PYTHON: "true"
    UV_NO_PROGRESS: "true"
    PIP_DISABLE_PIP_VERSION_CHECK: "true"
    ARTIFACTS_DIR: "ci-artifacts"
    INSTALL_PACKAGES: git curl

  cache:
    key:
      files:
        - pyproject.toml
    paths:
      - ${UV_CACHE_DIR}
      - .venv
    policy: pull-push
    when: "always"
  before_script:
    - . .gitlab/scripts/python-ci-setup.sh
    - |
      curl -L "https://gitlab.com/api/v4/projects/gitlab-org%2Fcli/packages/generic/glab/${GLAB_VERSION}/glab_${GLAB_VERSION}_linux_amd64.tar.gz" | tar xz -C /usr/local/
      chmod +x /usr/local/bin/glab
      glab --version
    - mkdir -p ${ARTIFACTS_DIR}
  artifacts:
    when: always
    expire_in: 1 week
    paths:
      - ${ARTIFACTS_DIR}
  timeout: 15 minutes

# Release job - creates semantic version releases with changelog
release:
  extends: .release_base
  script:
    # Run the release orchestrator (handles git config, versioning, and publishing)
    - .gitlab/scripts/create_release.py
  rules:
    # Only run on default branch, never on merge request events or tags
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_PIPELINE_SOURCE != "merge_request_event"'
      when: on_success
    - when: never
